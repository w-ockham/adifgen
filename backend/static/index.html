<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <!------------------------------------------------------------------>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.2/css/all.css">
  <!-- Google Fonts -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap">
  <!-- Bootstrap core CSS -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.0/css/bootstrap.min.css" rel="stylesheet">
  <!-- Material Design Bootstrap -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.19.1/css/mdb.min.css" rel="stylesheet">
  <!------------------------------------------------------------------>
  <style>
    .loglist-extend {
      position: relative;
      height: 35vh;
      border: 1px solid #aaa;
      min-height: 100px;
      overflow: auto;
      -webkit-overflow-scrolling: touch margin-bottom: -13px;
    }

    .csvlist-extend {
      position: relative;
      border: 2px solid #aaa;
      overflow: auto;
      min-width: 560px;
      height: 60vh;
      -webkit-overflow-scrolling: touch;
      margin-bottom: 5px;
    }

    .table-condensed>thead>tr>th,
    .table-condensed>tbody>tr>th,
    .table-condensed>tfoot>tr>th,
    .table-condensed>thead>tr>td,
    .table-condensed>tbody>tr>td,
    .table-condensed>tfoot>tr>td {
      padding: 1px;
    }
  </style>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-P5XNK2LGGK"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'G-P5XNK2LGGK');
  </script>
  <title> ADIF Tools</title>
</head>

<body>
  <div class="header clearfix">
    <div class="text-muted">
      <h5> ADIF生成ツール for SOTA/POTA/JAFF</h5>
    </div>
  </div>
  <ul class="nav nav-tabs nav-pills" role="tablist">
    <li class="nav-item">
      <a class="nav-link active" id="ADIFGenerator-tab" data-toggle="tab" href="#ADIFGenerator" role="tab"
        aria-controls="ADIFGenerator" aria-selected="false">ADIFGen for Hamlog</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="FLEOnline-tab" data-toggle="tab" href="#FLEOnline" role="tab" aria-controls="FLEOnline"
        aria-selected="false">FLE Online</a>
    </li>
  </ul>
  <div class="tab-content">
    <div class="tab-pane fade show active" id="ADIFGenerator" role="tabpanel" aria-labelledby="ADIFGenerator-tab">
      <form id="ActivatorForm" name="ActivatorForm" method="post" action="api/ADIFgen" onsubmit="generateADIF()"
        enctype="multipart/form-data" style="padding:10px">
        <div class="container">
          <div class="row">
            <div class="row">
              <div class="col-sm-4">
                <div class="form-group">
                  <label for="activator_call"><b> 運用時のコールサイン(必須)</b></label>
                  <input type="text" id="activator_call" name="activator_call" class="form-control"
                    placeholder="コールサイン(例:JL1NIE/1)" required>
                </div>
                <div class="form-group">
                  <label for="operator"><b>運用時のオペレータ(任意)</b></label>
                  <input type="text" id="operator" name="operator" class="form-control" placeholder="コールサイン(例:JL1NIE)">
                </div>
                <div class="form-group">
                  <h6><b>SOTA/JAFF/POTA運用先</b></h6>
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="my_qth" id="my_qth" value="form" checked>
                    <label for="park">リファレンス/公園番号を入力</label>
                    <input type="text" id="references" name="references" class="form-control"
                      placeholder="例: JAFF-0005 JA-0014">
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="my_qth" id="myQTH1" value="rmks1">
                    <label class="form-check-label" for="myQTH1">
                      Remarks1で指定する
                    </label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="my_qth" id="myQTH2" value="rmks2">
                    <label class="form-check-label" for="myQTH2">
                      Remarks2で指定する
                    </label>
                  </div>
                </div>
                <div class="form-group">
                  <h6><b>相手局のリファレンス/公園番号</b></h6>
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="his_qth" id="his_qth" value="none" checked>
                    <label class="form-check-label" for="his_qth">
                      指定しない
                    </label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="his_qth" id="QTH1" value="rmks1">
                    <label class="form-check-label" for="QTH1">
                      Remarks1で指定する
                    </label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="his_qth" id="QTH2" value="rmks2">
                    <label class="form-check-label" for="QTH2">
                      Remarks2で指定する
                    </label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="his_qth" id="QTH3" value="qth">
                    <label class="form-check-label" for="QTH3">
                      QTHで指定する
                    </label>
                  </div>
                </div>
              </div>
              <div class="col-sm-8" style="padding:0;">
                <div id="potacsvlist" class="container csvlist-extend">
                  <div class="table-responsive">
                    <table class="table table-striped table-condensed text-nowrap" style="font-size:8pt;">
                      <thead id="potacsvlisthead" class="thead-light">
                        <tr>
                          <th>No.</th>
                          <th>Call</th>
                          <th>Date</th>
                          <th>Time</th>
                          <th>Band</th>
                          <th>Mode</th>
                          <th>Sent</th>
                          <th>Rcvd</th>
                          <th>SigInfo</th>
                          <th>MySigInfo</th>
                          <th>Station</th>
                          <th>Operator</th>
                        </tr>
                      </thead>
                      <tbody id="csvlisttable">
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-sm-12">
              <div class="form-group">
                <div class="custom-file">
                  <input type="file" class="custom-file-input" id="filename" name="filename" required>
                  <label class="custom-file-label" for="csvfilename">HamLog CSVファイルを選択</label>
                  <div class="invalid-feedback">ファイルを指定してください</div>
                </div>
              </div>
              <div class="form-group">
                <button type="button" class="btn-sm btn-primary" onclick="readCSV()">CSV読込
                </button>
                <button type="submit" class="btn-sm btn-primary">ADIF生成</button>
                <a href="https://www.sotadata.org.uk/" target="_blank" class="btn-sm btn-outline-info"
                  role="button">SOTAログアップロード</a>
                <a href="mailto:jaff-log@nifty.com" target="_blank" class="btn-sm btn-outline-info"
                  role="button">JAFFログ送付</a>
                <a href="https://pota.app/#/user/logs" target="_blank" class="btn-sm btn-outline-info"
                  role="button">POTAログアップロード</a>
                <a href="https://bit.ly/35Wfj4J" target="_blank" class="btn-sm btn-info" role="button">使い方</a>
              </div>
            </div>
          </div>
        </div>
      </form>
    </div><!-- end of tab-pane -->
    <div class="tab-pane fade" id="FLEOnline" role="tabpanel" aria-labelledby="FLEOnline-tab">
      <form name="FLEEdit" method="post" onsubmit="return checkLog()" action='/cgi-bin/fleonline.py'>
        <div class="container">
          <div class="form-group">
            <ul class=" nav nav-tabs nav-pills" role="tablist">
              <li class="nav-item">
                <a class="nav-link active p-1" id="SOTAJAFF-tab" data-toggle="tab" href="#SOTAJAFF" role="tab"
                  aria-controls="SOTAJAFF" aria-selected="true"><small>SOTA/WWFF/POTA</small></a>
              </li>
              <li class="nav-item">
                <a class="nav-link p-1" id="HAMLOG-tab" data-toggle="tab" href="#HAMLOG" role="tab"
                  aria-controls="HAMLOG" aria-selected="false"><small>HAMLOG</small></a>
              </li>
            </ul>
            <div class="tab-content">
              <div class="tab-pane show active" id="SOTAJAFF" role="tabpanel" aria-labelledby="SOTAJAFF-tab">
                <div id="loglist" class="container loglist-extend">
                  <div class="table-responsive">
                    <table class="table table-striped table-condensed text-nowrap" style="font-size:8pt;">
                      <thead id="loglisthead" class="thead-light">
                        <tr>
                          <th>No.</th>
                          <th>My Call</th>
                          <th>Date</th>
                          <th>Time</th>
                          <th>Call</th>
                          <th>Band</th>
                          <th>Mode</th>
                          <th>RSTs</th>
                          <th>RSTr</th>
                          <th>My SOTA</th>
                          <th>His SOTA</th>
                          <th>My SigInfo</th>
                          <th>His SigInfo</th>
                          <th>Comment</th>
                          <th>Operator</th>
                        </tr>
                      </thead>
                      <tbody id="loglisttable">
                    </table>
                  </div>
                </div>
              </div>
              <div class="tab-pane" id="HAMLOG" role="tabpanel" aria-labelledby="HAMLOG-tab">
                <div id="hamloglist" class="container loglist-extend">
                  <div class="table-responsive">
                    <table class="table table-striped table-condensed text-nowrap" style="font-size:8pt;">
                      <thead id="hamloglisthead" class="thead-light">
                        <tr>
                          <th>No.</th>
                          <th>Call</th>
                          <th>Date</th>
                          <th>Time</th>
                          <th>His</th>
                          <th>My</th>
                          <th>Freq</th>
                          <th>Mode</th>
                          <th>GL</th>
                          <th>Name</th>
                          <th>QTH</th>
                          <th>Remarks2</th>
                        </tr>
                      </thead>
                      <tbody id="hamloglisttable">
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="form-group d-flex" style="justify-content:flex-end;margin-bottom:-1px;">
            <div class="form-check form-check-inline" style="font-size:8pt">
              <input class="form-check-input" disabled="disabled" type="checkbox" id="checkSOTA">
              <label class="form-check-label" for="checkSOTA"><strong>SOTA</strong></label>
            </div>
            <div class="form-check form-check-inline" style="font-size:8pt">
              <input class="form-check-input" disabled="disabled" type="checkbox" id="checkWWFF">
              <label class="form-check-label" for="checWWFF"><strong>WWFF/POTA</strong></label>
            </div>
            <div class="button-group">
              <a role="button" class="btn-sm btn-outline-info p-1 bg-light" style="font-size 4px"
                href="https://jl1nie.wordpress.com/2019/08/21/2019-08-21-203013/" target="_blank">Help</a>
              <button type="button" class="btn-sm btn-info p-1 bg-light" style="font-size 4px" onClick="setSample()">FLE
                Sample</button>
              <button type="button" class="btn-sm btn-info p-1 bg-light" style="font-size 4px"
                onClick="setSample('clear')">Clear</button>
            </div>
          </div>
          <div class="form-group">
            <textarea class="form-control text-monospace" name="edittext" id="edittext"
              style="resize:none; font-size: 9pt;line-height: 10pt;margin-top:2pt;height:40vh"></textarea>
          </div>
          <div class="form-group">
            <div class="button-group d-flex" style="justify-content:space-around">
              <input id="loadfle" type="file" style="display:none">
              <button type="button" class="btn-sm btn-primary" onClick="$('input[id=loadfle]').click()">FLEログ読込</button>
              <input id="appendADIF" type="file" style="display:none">
              <button type="button" class="btn-sm btn-primary"
                onClick="$('input[id=appendADIF]').click()">ADIFログ追加</button>
              <button type="button" id="update" class="btn-info btn-sm" onClick="clickUpdate()">変換</button>
              <button type="submit" id="generate" class="btn-primary btn-sm">CSVファイル生成</button>
            </div>
          </div>
        </div>
      </form>
    </div><!-- end of tab-pane -->
  </div>

  <!-- Optional JavaScript -->
  <!-- jQuery first, then Popper.js, then Bootstrap JS -->
  <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"></script>
  <!---------------------------------------------------------------------->
  <!-- JQuery -->
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/js-cookie@rc/dist/js.cookie.min.js"></script>
  <!-- Bootstrap tooltips -->
  <script type="text/javascript"
    src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.4/umd/popper.min.js"></script>
  <!-- Bootstrap core JavaScript -->
  <script type="text/javascript"
    src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.0/js/bootstrap.min.js"></script>
  <!-- MDB core JavaScript -->
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.19.1/js/mdb.min.js"></script>
  <!------------------------------------------------------------------------>

  <script>
    var csv_checked = false;

    $('.custom-file-input').on('change', function () {
      $(this).next('.custom-file-label').html($(this)[0].files[0].name);
      csv_checked = false;
    });

    $('.custom-file-input').on('click', function () {
      this.value = null;
    });

    function checkRefs(refid) {
      refid = refid.toUpperCase()
      refs = refid.trim().split(/,|\s/);

      sotaref = new RegExp(/^\w+\/\w+-\d{3}$/);
      parkref = new RegExp(/^\w+-\d{4}$/);

      result = true;

      refs.forEach((ref) => {
        if (sotaref.test(ref) || parkref.test(ref)) {
          result = result && true;
        } else
          result = false;
      })

      return result;
    }

    function checkForm() {
      var form = document.forms.ActivatorForm;
      var errmsg = '';

      if (form.activator_call.value == "") {
        errmsg += '運用時のコールサインを入力して下さい\n';
      }

      if (form.my_qth.value == "form") {
        if (form.references.value == "") {
          errmsg += '運用先を入力して下さい\n';
        }
        if (!checkRefs(form.references.value)) {
          errmsg += '運用先リファレンスに誤りがあります\n';
        }
      }

      if (form.my_qth.value == "rmks1" && form.his_qth.value == "rmks1") {
        errmsg += 'Remarks1の指定が重複しています\n';
      }

      if (form.my_qth.value == "rmks2" && form.his_qth.value == "rmks2") {
        errmsg += 'Remarks2の指定が重複しています\n';
      }
      if (form.filename.value == "") {
        errmsg += 'HAMLOG CSVファイルを指定してください';
      }

      return errmsg;
    };

    function generateADIF() {
      let errmsg = checkForm();
      if (errmsg.length > 0) {
        alert(errmsg);
        return false;
      }
      if (csv_checked == false) {
        if (confirm("HAMLOG CSVのチェックをせずにADIFを生成しますか？") == false)
          return false;
      }
      saveCookie();
      return true;
    };

    async function readCSV() {
      let errmsg = checkForm();
      if (errmsg.length > 0) {
        alert(errmsg);
        return false;
      }

      var form = $('#ActivatorForm').get(0);
      var formdata = new FormData(form);
      adiflist = []
      for (const [key, value] of formdata) {
        console.log(`${key}: ${value}\n`);
      }

      let res = await fetch('/api/ADIFcheck', {
        method: 'POST',
        body: formdata,
      });

      let data = await res.json();
      $('#potacsvlisthead').empty();
      $('#potacsvlisthead').append(
        "<tr><th>No.</th><th>Call</th>" +
        "<th>Date</th><th>Time</th>" +
        "<th>Band</th><th>Mode</th>" +
        "<th>Sent</th><th>Rcvd</th><th>SigInfo</th>" +
        "<th>MySigInfo</th><th>Station</th><th>Operator</th>" +
        "</tr>");
      $('#potacsvlisttable').empty();

      if (data.status == "OK")
        csv_checked = true;
      else {
        csv_checked = false;
        console.log(data.errorlog);
        alert('CSVファイルにエラーがあります。\n' + data.errorlog);
      }

      tlist = data.logtext;
      var count = 1
      for (var i = 0, len = tlist.length; i < len; ++i, ++count) {
        td = "<td>" + count + "</td>";
        for (var j = 0, len2 = tlist[i].length; j < len2; ++j)
          td = td + "<td>" + tlist[i][j] + "&nbsp</td>";
        $('#potacsvlisttable').append('<tr>' + td + '</tr>');
      }
      adiflist = data.filelist;
    };

    var textdirty = false;
    var textinterpreted = false;

    $('textarea[id=edittext]').keyup(function () {
      textdirty = true;
      textinterpreted = false;
    })

    $('input[id=loadfle]').change(function (e) {
      if (textdirty) {
        if (confirm("修正されたFLEログがクリアされます") == false)
          return
      }
      var result = e.target.files[0];
      var reader = new FileReader();
      reader.readAsText(result, 'UTF-8');
      $('input[id=loadfle]').val('');
      reader.addEventListener('load', function () {
        editor = document.getElementById("edittext")
        editor.value = reader.result;
        textdirty = false;
      })
    });

    function adif2fle(text) {
      var adiftext = text.toUpperCase().split('<EOR>');
      var today = '', mode = '', band = '';
      var result = '';
      for (const elem of adiftext) {
        var qso = '';
        var call = elem.match(/<CALL:\d>([A-Z0-9\/]+)[\s<]/);
        if (call == null)
          continue;
        var newmode = elem.match(/<MODE:\d>(\S+)[\s<]/);
        var newband = elem.match(/<BAND:\d>([0-9]+[A-Z]+)/);
        var newday = elem.match(/<QSO_DATE:\d>(\d+)[\s<]/);
        var time = elem.match(/<TIME_ON:\d>(\d+)[\s<]/);
        var sent = elem.match(/<RST_SENT:\d>([0-9\+\-]+)[\s<]/);
        var recv = elem.match(/<RST_RCVD:\d>([0-9\+\-]+)[\s<]/);

        if (newday[1] != today) {
          var d = newday[1];
          qso += 'date ' + d.substring(0, 4) + '-' + d.substring(4, 6) + '-' + d.substring(6, 8) + '\r\n';
          today = newday[1];
        }
        if (newband[1] != band || newmode[1] != mode) {
          band = newband[1];
          mode = newmode[1];
          qso += band.toLowerCase() + ' ' + mode + '\r\n';
        }
        qso += time[1].substring(0, 4) + ' ' + call[1] + ' ' + sent[1] + ' ' + recv[1] + '\r\n';
        console.log(qso);

        result += qso;
      }
      return (result);
    }

    $('input[id=appendADIF]').change(function (e) {
      var result = e.target.files[0];
      var reader = new FileReader();
      reader.readAsText(result, 'UTF-8');
      $('input[id=appendADIF]').val('');
      reader.addEventListener('load', function () {
        editor = document.getElementById("edittext")
        editor.value += adif2fle(reader.result);
        textdirty = false;
      })
    });

    loadCookie();

    function saveCookie() {
      var act_call = $('#activator_call').val();
      var operator = $('#operator').val();
      var chsr_call = $('#chaser_call').val();
      var portable = $('#SOTABoth [name="portable"]').filter(':checked').val();
      var myQTH_b = $('#SOTABoth [name="myQTH"]').filter(':checked').val();
      var actQTH_b = $('#SOTABoth [name="hisQTH"]').filter(':checked').val();
      var note_b = $('#SOTABoth [name="Note"]').filter(':checked').val();
      var myQTH = $('#SOTAActivator [name="myQTH"]').filter(':checked').val();
      var actQTH = $('#SOTAActivator [name="QTH"]').filter(':checked').val();
      var hisQTH = $('#SOTAChaser [name="QTH"]').filter(':checked').val();
      var myQTHp = $('#POTAActivator [name="myQTH"]').filter(':checked').val();
      var actQTHp = $('#POTAActivator [name="QTH"]').filter(':checked').val();

      Cookies.set('act_call_b', act_call_b, { expires: 180 });
      Cookies.set('portable', portable, { expires: 180 });
      Cookies.set('myQTH_b', myQTH_b, { expires: 180 });
      Cookies.set('actQTH_b', actQTH_b, { expires: 180 });
      Cookies.set('note_b', note_b, { expires: 180 });

      Cookies.set('act_call', act_call, { expires: 180 });
      Cookies.set('chsr_call', chsr_call, { expires: 180 });
      Cookies.set('myQTH', myQTH, { expires: 180 });
      Cookies.set('actQTH', actQTH, { expires: 180 });
      Cookies.set('hisQTH', hisQTH, { expires: 180 });

      Cookies.set('pota_act_call', pota_act_call, { expires: 180 });
      Cookies.set('pota_operator', pota_operator, { expires: 180 });
      Cookies.set('myQTHp', myQTHp, { expires: 180 });
      Cookies.set('actQTHp', actQTHp, { expires: 180 });
    }

    function loadCookie() {
      $('#activation_call_both').val([Cookies.get('act_call_b')]);
      $('#activation_call').val([Cookies.get('act_call')]);
      $('#pota_activation_call').val([Cookies.get('pota_act_call')]);
      $('#pota_operator').val([Cookies.get('pota_operator')]);
      $('#chaser_call').val([Cookies.get('chsr_call')]);

      var myQTH = Cookies.get('myQTH');
      var aQTH = Cookies.get('actQTH');
      var cQTH = Cookies.get('hisQTH');

      if (myQTH == undefined)
        $('#SOTAActivator [name="myQTH"]').val(["form"]);
      else
        $('#SOTAActivator [name="myQTH"]').val([myQTH]);

      if (aQTH == undefined)
        $('#SOTAActivator [name="hisQTH"]').val(["none"]);
      else
        $('#SOTAActivator [name="hisQTH"]').val([aQTH]);

      if (cQTH == undefined)
        $('#SOTAChaser [name="QTH"]').val(["rmks1"]);
      else
        $('#SOTAChaser [name="QTH"]').val([cQTH]);

      var myQTHp = Cookies.get('myQTHp');
      var aQTHp = Cookies.get('actQTHp');

      if (myQTHp == undefined)
        $('#POTAActivator [name="myQTH"]').val(["form"]);
      else
        $('#POTAActivator [name="myQTH"]').val([myQTHp]);

      if (aQTHp == undefined)
        $('#POTAActivator [name="QTH"]').val(["none"]);
      else
        $('#POTAActivator [name="QTH"]').val([aQTHp]);

      var myQTH_b = Cookies.get('myQTH_b');
      var aQTH_b = Cookies.get('actQTH_b');
      var portable = Cookies.get('portable');
      var note_b = Cookies.get('note_b');

      if (myQTH_b == undefined)
        $('#SOTABoth [name="myQTH"]').val(["rmks1"]);
      else
        $('#SOTABoth [name="myQTH"]').val([myQTH_b]);

      if (aQTH_b == undefined)
        $('#SOTABoth [name="hisQTH"]').val(["rmks2"]);
      else
        $('#SOTABoth [name="hisQTH"]').val([aQTH_b]);

      if (portable == undefined)
        $('#SOTABoth [name="portable"]').val(["none"]);
      else
        $('#SOTABoth [name="portable"]').val([portable]);

      if (note_b == undefined)
        $('#SOTABoth [name="Note"]').val(["rmks2"]);
      else
        $('#SOTABoth [name="Note"]').val([note_b]);

    }

    function checkLog() {
      if (!textinterpreted) {
        if (confirm("変換されていません\nCSV生成しますか？") == false)
          return false;
      }
      textdirty = false;
      textinterpreted = true;
      return true;
    }

    function setSample(arg) {
      editor = document.getElementById("edittext")
      if (textdirty) {
        if (confirm("FLEログをクリアします") == false)
          return
      }

      textdirty = false;
      clearLog();

      act_call = Cookies.get('pota_act_call')
      if (act_call == undefined) {
        act_call = Cookies.get('act_call')
        if (act_call == undefined)
          act_call = 'jl1nie/0'
      }
      operator = act_call;
      pos = act_call.indexOf('/')
      if (pos != -1)
        operator = act_call.substring(0, pos)

      d = new Date()
      dddd = d.getFullYear() + '-' + String(d.getMonth() + 1) + '-' + d.getDate();
      if (arg == "clear") {
        editor.value = ""
      } else {
        editor.value =
          "#Header\n" +
          "mycall " + act_call + "\n" +
          "operator " + operator + "\n" +
          "mywwff jaff-0218\n" +
          "mypota ja-1151 ja-1164\n" +
          "mysota ja/st-012\n" +
          "qslmsg $sat丸山$mysota $mypota $rig\n" +
          "#Log\n" +
          "timezone +0\n" +
          "date " + dddd + "\n" +
          "rigset 1\n" +
          "40m cw\n" +
          "2302 ja1qsa \n" +
          "4 ja4qru 6 7 <曽田さん>{島根市}\n" +
          "4 ja8qsw 4 {札幌市}\n" +
          "ssb\n" +
          "14 ja4qsy\n" +
          "40 jq1qso/1 5 3 jaff-0218 ja-1151 ja-1164\n" +
          "70cm fm\n" +
          "55 jg0qro/0 ja/nn-001 {松本市 AO-91/FM/144MHz}\n" +
          "58 jk2qsu {PM85rl AO-91/FM/144MHz}\n" +
          "day +\n" +
          "17m cw\n" +
          "rigset 0\n" +
          "04 zl1qsb 41 31\n" +
          "20m ft4\n" +
          "45 zl1qrz -18 -19\n" +
          "rigset 2\n" +
          "50.550 am\n" +
          "0130 jj1qth 3 4\n";
      }
    }

    function clearLog() {
      sota = document.getElementById("checkSOTA");
      sota.checked = false;
      wwff = document.getElementById("checkWWFF");
      wwff.checked = false;
      textinterpreted = false;
      $('#loglisthead').empty();
      $('#loglisthead').append("<tr><th>No.</th><th>My Call</th>" +
        "<th>Date</th><th>Time</th>" +
        "<th>Call</th><th>Band</th>" +
        "<th>Mode</th><th>RSTs</th><th>RSTr</th>" +
        "<th>My SOTA</th><th>His SOTA</th>" +
        "<th>My SigInfo</th><th>His SigInfo</th>" +
        "<th>Comment</th>" +
        "<th>Operator</th>" +
        "</tr>");
      $('#loglisttable').empty();

      $('#hamloglisthead').empty();
      $('#hamloglisthead').append("<tr><th>No.</th><th>Call</th><th>Date</th><th>Time</th>" +
        "<th>His</th><th>My</th><th>Freq</th>" +
        "<th>Mode</th><th>GL</th><th>Name</th>" +
        "<th>QTH</th><th>Remarks2</th></tr>");
      $('#hamloglisttable').empty();
    }

    function clickUpdate() {
      editor = document.getElementById("edittext")
      txt = editor.value
      $.post("/cgi-bin/fleonline.py",
        {
          "command": "interp",
          "arg": txt
        },
        function (data, status, xhr) {
          if (data.status == "OK") {
            clearLog()
            textinterpreted = true;
            if (data.logtype == "SOTA") {
              sota = document.getElementById("checkSOTA");
              sota.checked = true;
              wwff = document.getElementById("checkWWFF");
              wwff.checked = false;
            } else if (data.logtype == "WWFF") {
              wwff = document.getElementById("checkWWFF");
              sota = document.getElementById("checkSOTA");
              sota.checked = false;
              wwff.checked = true;
            } else if (data.logtype == "BOTH") {
              sota = document.getElementById("checkSOTA");
              sota.checked = true;
              wwff = document.getElementById("checkWWFF");
              wwff.checked = true;
            } else {
              sota = document.getElementById("checkSOTA");
              sota.checked = false;
              wwff = document.getElementById("checkWWFF");
              wwff.checked = false;
            }
            tlist = data.logtext;
            for (var i = 0, len = tlist.length; i < len; ++i) {
              td = "";
              for (var j = 0, len2 = tlist[i].length; j < len2; ++j)
                td = td + "<td>" + tlist[i][j] + "</td>";
              $('#loglisttable').append('<tr>' + td + '</tr>');
            }
            tlist = data.hamlogtext;
            for (var i = 0, len = tlist.length; i < len; ++i) {
              td = "";
              for (var j = 0, len2 = tlist[i].length; j < len2; ++j)
                td = td + "<td>" + tlist[i][j] + "</td>";
              $('#hamloglisttable').append('<tr>' + td + '</tr>');
            }
          } else {
            textinterpreted = false;
            $('#loglisthead').empty()
            $('#loglisthead').append("<tr><th>Line#</th><th>Text</th></tr>");
            tlist = data.logtext;
            $('#loglisttable').empty()
            for (var i = 0, len = tlist.length; i < len; ++i) {
              tr = "<tr>"
              tr = tr + "<td>" + tlist[i][0] + "</td>"
              tr = tr + "<td>" + tlist[i][2]
              if (tlist[i][1] != '')
                tr = tr + "<font color=\"#ff0000\"><b>&nbspError!&nbsp" + tlist[i][1] + "</b></font>"
              tr = tr + "</td></tr>"
              $('#loglisttable').append(tr);
            }

            $('#hamloglisthead').empty()
            $('#hamloglisthead').append("<tr><th>Line#</th><th>Text</th></tr>");
            tlist = data.logtext;
            $('#hamloglisttable').empty()
            for (var i = 0, len = tlist.length; i < len; ++i) {
              tr = "<tr>"
              tr = tr + "<td>" + tlist[i][0] + "</td>"
              tr = tr + "<td>" + tlist[i][2]
              if (tlist[i][1] != '')
                tr = tr + "<font color=\"#ff0000\"><b>&nbspError!&nbsp" + tlist[i][1] + "</b></font>"
              tr = tr + "</td></tr>"
              $('#hamloglisttable').append(tr);
            }
          }
        });
    };

    var adiflist = [];
  </script>
</body>

</html>